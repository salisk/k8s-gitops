---
version: "3"

tasks:
  test:
    desc: Test Flux configuration with flux-local
    summary: |
      Validates all Flux HelmReleases and Kustomizations in the cluster directory.
      Requires: Docker or flux-local installed locally
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 test --enable-helm --all-namespaces --path /workspace/cluster -v

  diff:helmrelease:
    desc: Show HelmRelease diff between current and main branch
    summary: |
      Shows differences in HelmReleases between your current branch and main.
      Useful for reviewing changes before creating a PR.
    cmds:
      - |
        docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 \
          diff helmrelease \
          --unified 6 \
          --path /workspace/cluster \
          --path-orig /workspace/cluster \
          --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart" \
          --all-namespaces \
          --sources "flux-system"

  diff:kustomization:
    desc: Show Kustomization diff between current and main branch
    summary: |
      Shows differences in Kustomizations between your current branch and main.
      Useful for reviewing changes before creating a PR.
    cmds:
      - |
        docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 \
          diff kustomization \
          --unified 6 \
          --path /workspace/cluster \
          --path-orig /workspace/cluster \
          --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart" \
          --all-namespaces \
          --sources "flux-system"

  build:
    desc: Build all Flux resources and show what would be deployed
    summary: |
      Renders all Flux HelmReleases and Kustomizations to see the final Kubernetes manifests.
      Useful for debugging templating issues.
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 build --enable-helm --all-namespaces --path /workspace/cluster

  get:helmreleases:
    desc: List all HelmReleases in the cluster configuration
    summary: |
      Shows all HelmReleases that would be deployed by Flux.
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 get helmrelease --all-namespaces --path /workspace/cluster

  get:kustomizations:
    desc: List all Kustomizations in the cluster configuration
    summary: |
      Shows all Kustomizations that would be deployed by Flux.
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/workspace ghcr.io/allenporter/flux-local:v8.0.1 get kustomization --all-namespaces --path /workspace/cluster
